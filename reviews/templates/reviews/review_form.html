{% extends "base.html" %}
{% block content %}
<section class="shop" style="display:flex; justify-content:center;">
  <div class="glass-panel" style="padding:24px; max-width:700px; width:100%;">
    <h1 style="margin-top:0;">Review: {{ product.name }}</h1>

    <form method="post">
      {% csrf_token %}

      {# Hidden real field that gets POSTed as "rating" #}
      <input type="hidden" name="rating" id="ratingInput" value="{{ form.rating.value|default:5 }}"/>

      <div style="margin-top:14px;">
        <label style="display:block; font-weight:700; margin-bottom:8px;">Rating</label>

        <div style="display:flex; align-items:center; gap:14px; flex-wrap:wrap;">
          {# Gold stars display (clickable) #}
          <div id="starRow" style="font-size:1.8rem; letter-spacing:3px; line-height:1;">
            <button type="button" class="starBtn" data-val="1" aria-label="1 star" style="all:unset; cursor:pointer;">★</button>
            <button type="button" class="starBtn" data-val="2" aria-label="2 stars" style="all:unset; cursor:pointer;">★</button>
            <button type="button" class="starBtn" data-val="3" aria-label="3 stars" style="all:unset; cursor:pointer;">★</button>
            <button type="button" class="starBtn" data-val="4" aria-label="4 stars" style="all:unset; cursor:pointer;">★</button>
            <button type="button" class="starBtn" data-val="5" aria-label="5 stars" style="all:unset; cursor:pointer;">★</button>
          </div>

          {# Slider control #}
          <div style="min-width: 220px; flex: 1;">
            <input
              id="ratingSlider"
              type="range"
              min="1"
              max="5"
              step="1"
              value="{{ form.rating.value|default:5 }}"
              style="width:100%; accent-color:#d4af37;"
            />
            <div style="display:flex; justify-content:space-between; font-size:12px; opacity:.75; margin-top:6px;">
              <span>1</span><span>2</span><span>3</span><span>4</span><span>5</span>
            </div>
          </div>

          <div style="font-weight:700; opacity:.9;">
            <span id="ratingLabel"></span>
          </div>
        </div>

        {# If Django form had errors for rating, show them #}
        {% if form.rating.errors %}
          <div style="margin-top:8px; color:#ffb3b3;">
            {{ form.rating.errors }}
          </div>
        {% endif %}
      </div>

      <div style="margin-top:18px;">
        <label style="display:block; font-weight:700; margin-bottom:8px;">Comment (optional)</label>
        {{ form.comment }}
        <div style="opacity:.75; font-size:.9rem; margin-top:6px;">Max 300 characters.</div>

        {% if form.comment.errors %}
          <div style="margin-top:8px; color:#ffb3b3;">
            {{ form.comment.errors }}
          </div>
        {% endif %}
      </div>

      <div style="margin-top:16px; display:flex; gap:10px; flex-wrap:wrap;">
        <button class="button button--gold" type="submit">Save review</button>
        <a class="button" href="{% url 'catalog:product_detail' slug=product.slug %}">Cancel</a>
      </div>
    </form>
  </div>
</section>

<script>
  (function () {
    const slider = document.getElementById("ratingSlider");
    const input = document.getElementById("ratingInput");
    const label = document.getElementById("ratingLabel");
    const stars = Array.from(document.querySelectorAll(".starBtn"));

    function paint(val) {
      const n = parseInt(val || "5", 10);
      input.value = String(n);
      slider.value = String(n);
      label.textContent = n + "/5";

      stars.forEach((btn, i) => {
        btn.style.color = (i < n) ? "#d4af37" : "rgba(255,255,255,0.25)";
        btn.style.textShadow = (i < n) ? "0 0 10px rgba(212,175,55,0.25)" : "none";
      });
    }

    slider.addEventListener("input", (e) => paint(e.target.value));

    stars.forEach((btn) => {
      btn.addEventListener("click", () => paint(btn.dataset.val));
      btn.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          paint(btn.dataset.val);
        }
      });
      btn.tabIndex = 0;
    });

    paint(input.value);
  })();
</script>
{% endblock %}
