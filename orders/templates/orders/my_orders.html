{% extends 'base.html' %}
{% block content %}
  <section class="shop">
    <div class="glass-panel" style="padding:18px;">
      <h1>My Orders</h1>

      {% if orders %}
        <ul style="list-style:none; padding-left:0; margin-top:12px;">
          {% for o in orders %}
            <li style="padding:12px; border-bottom:1px solid rgba(255,255,255,0.08);">
              <div style="display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap;">
                <div>
                  <strong><a href="{% url 'orders:order_detail' o.order_number %}">{{ o.order_number }}</a></strong>
                  <div style="opacity:.85; font-size:0.95rem;">{{ o.created_at|date:'j M Y, H:i' }} • {{ o.status|title }}</div>
                </div>
                <div>
                  <strong>{{ o.total }} {{ o.currency }}</strong>
                </div>
              </div>

              {% if o.status == 'paid' or o.status == 'complete' %}
                {% if o.items.all %}
                  <div style="margin-top:12px; padding-top:10px; border-top:1px solid rgba(255,255,255,0.08);">
                    <div style="font-weight:600; margin-bottom:8px;">Items</div>

                    <ul style="list-style:none; padding-left:0; margin:0; display:grid; gap:10px;">
                      {% for item in o.items.all %}
                        <li style="display:flex; justify-content:space-between; gap:12px; align-items:center; flex-wrap:wrap;">
                          <div style="opacity:.95;">
                            {{ item.product.name }}
                            {% if item.quantity %}
                              <span style="opacity:.7;">× {{ item.quantity }}</span>
                            {% endif %}
                          </div>

                          {# Because your view prefetched only THIS user's reviews, .first will be their review or nothing #}
                          {% with my_review=item.product.reviews.first %}
                            <a class="button button--gold" href="{% url 'reviews:add_from_order' order.order_number item.product.id %}">
                              {% if my_review %}
                                Edit review
                              {% else %}
                                Write review
                              {% endif %}
                            </a>
                          {% endwith %}
                        </li>
                      {% endfor %}
                    </ul>
                  </div>
                {% endif %}
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p style="margin-top:12px;">No orders yet. Your future self will thank you.</p>
      {% endif %}

      <div style="margin-top:14px;">
        <a class="button button--gold" href="{% url 'catalog:product_list' %}">Return to store</a>
      </div>
    </div>
  </section>
{% endblock %}
