{% extends "base.html" %}
{% load static %}

{% block content %}
<section class="pd">
  <div class="pd-gallery glass-panel">

    <div class="pd-viewerbar" aria-label="Image view controls">
      <button type="button" class="pd-viewerbtn is-active" data-mode="fit">Fit</button>
      <button type="button" class="pd-viewerbtn" data-mode="fill">Fill</button>
    </div>

    <div class="pd-main" aria-label="Main product image viewer">
      {% with first=product.images.first %}
        {% if first %}
          <img
            id="pdMainImg"
            class="pd-main-img"
            src="{{ first.image.url }}"
            alt="{{ product.name }}"
            loading="eager"
          />
        {% else %}
          <div class="pd-main-placeholder">No image yet</div>
        {% endif %}
      {% endwith %}
    </div>

    {% if product.images.count %}
      <div class="pd-thumbs" aria-label="Product image thumbnails">
        {% for img in product.images.all %}
          <button
            class="pd-thumb"
            type="button"
            data-src="{{ img.image.url }}"
            aria-label="View image {{ forloop.counter }}"
          >
            <img
              src="{{ img.image.url }}"
              alt="{{ product.name }} thumbnail {{ forloop.counter }}"
              loading="lazy"
            />
          </button>
        {% endfor %}
      </div>
    {% endif %}

  </div>

  <div class="pd-info glass-panel">
    <h1 class="pd-title">{{ product.name }}</h1>
    <p class="pd-price">£{{ product.price }}</p>

    {% if product.description %}
      <p class="pd-desc">{{ product.description }}</p>
    {% endif %}

    <ul class="pd-meta">
      {% if product.fabric_origin %}
        <li><strong>Fabric:</strong> {{ product.fabric_origin }}</li>
      {% endif %}
      <li><strong>Condition:</strong> {{ product.get_condition_grade_display }}</li>
      {% if product.size %}
        <li><strong>Size:</strong> {{ product.size }}</li>
      {% endif %}
    </ul>

    <form method="post" action="{% url 'cart:add' product.id %}">
      {% csrf_token %}
      <input type="hidden" name="next" value="{{ request.get_full_path }}">
      <div class="pd-actions">
        <button class="button button--gold" type="submit">
          Add to cart
        </button>
      </div>
    </form>

    <!-- REVIEW CTA -->
    <div style="margin-top:18px;">
      {% if user.is_authenticated %}
        <a class="button button--gold" href="{% url 'reviews:review_product' product.id %}">
          Write / edit review
        </a>
      {% else %}
        <p style="opacity:.85;">
          <a href="{% url 'account_login' %}">Log in</a> to leave a review.
        </p>
      {% endif %}
    </div>

    <!-- REVIEWS -->
    <div style="margin-top:24px;">
      <h3>Reviews</h3>

      {% if product.reviews.all %}
        <ul style="list-style:none; padding-left:0; margin-top:10px;">
          {% for r in product.reviews.all %}
            <li style="padding:12px 0; border-bottom:1px solid rgba(255,255,255,0.08);">

              <!-- Stars -->
              <div style="font-size:1.2rem; color:#d4af37; letter-spacing:2px;">
                {{ "★★★★★"|slice:":r.rating" }}
                <span style="color:rgba(255,255,255,0.25);">
                  {{ "★★★★★"|slice:"r.rating:" }}
                </span>
              </div>

              <div style="margin-top:4px; font-weight:600;">
                {{ r.user }}
              </div>

              {% if r.text %}
                <div style="margin-top:6px; opacity:.9;">
                  {{ r.text }}
                </div>
              {% endif %}

              <div style="margin-top:4px; font-size:.85rem; opacity:.7;">
                {{ r.created_at|date:"j M Y" }}
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p style="opacity:.8; margin-top:8px;">No reviews yet.</p>
      {% endif %}
    </div>

  </div>
</section>

<script src="{% static 'js/product_detail.js' %}"></script>
{% endblock %}
